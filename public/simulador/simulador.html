<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Unity Simulator (Headset)</title>
  <link rel="stylesheet" href="simulador.css">
</head>

<body>
  <div class="app">
    <header class="topbar">
      <div class="title">
        <h2>Unity Simulator</h2>
        <div class="subtitle">Headset (WebSocket + WebRTC)</div>
      </div>

      <div class="conn">
        <input id="wsUrl" class="ws" placeholder="ws(s)://...">
        <button id="btnConnect" class="primary">Connect</button>
        <button id="btnDisconnect" class="ghost">Disconnect</button>
      </div>
    </header>

    <main class="main">
      <section class="left">
        <div class="card">
          <div class="card-title">
            <span>Video</span>
            <span id="pcState" class="pill">PC: idle</span>
          </div>
          <video id="vid" autoplay playsinline muted></video>
          <div class="small tip">
            Tip: selecciona un robot, luego <b>Start WebRTC</b>. Si cambias de robot, el simulador reinicia WebRTC automáticamente.
          </div>
        </div>

        <div class="card" style="margin-top:14px;">
          <div class="card-title">
            <span>Logs</span>
            <span class="pill">WS + WebRTC</span>
          </div>
          <pre id="log"></pre>
        </div>
      </section>

      <aside class="right">
        <div class="card">
          <div class="card-title">
            <span>Robot</span>
            <span id="wsState" class="pill">WS: disconnected</span>
          </div>

          <div class="row">
            <select id="robotList" class="grow"></select>
            <button id="btnSelect">Select</button>
          </div>

          <div class="row" style="margin-top:10px;">
            <button id="btnStart" class="primary grow">Start WebRTC</button>
          </div>

          <div class="row" style="margin-top:10px;">
            <button id="btnSendControl" class="ghost grow">Send Control (test)</button>
            <button id="btnSendViewport" class="ghost grow">Send Viewport (test)</button>
          </div>

          <div class="row" style="margin-top:10px;">
            <button id="btnClearLog" class="ghost grow">Clear logs</button>
            <button id="btnCenterViewport" class="ghost">Center View</button>
            <button id="btnCenterMove" class="ghost">Center Move</button>
          </div>
        </div>
        
        <div class="card" style="margin-top:14px;">
          <div class="card-title">
            <span>Latency Stats</span>
          </div>
          <div class="logs">
            <div id="rttDisplay">RTT: n/a</div>
            <div id="rxLatencyDisplay">RX Latency: n/a</div>
          </div>
        </div>
        
        <div class="card" style="margin-top:14px;">
          <div class="card-title">
            <span>Controls</span>
            <span class="pill">viewport + locomotion</span>
          </div>

          <div class="controls-grid">
            <!-- Viewport joystick -->
            <div class="panel">
              <div class="panel-title">
                <span>Head / Viewport</span>
                <span class="pill tiny">~30 Hz</span>
              </div>

              <div class="row" style="gap:14px;">
                <canvas id="joyViewport" width="220" height="220"></canvas>

                <div class="grow">
                  <div class="label">Viewport state</div>
                  <pre id="vpState" class="mini-pre">yawDeg: 0
pitchDeg: 0
hfovDeg: 120
vfovDeg: 120</pre>
                </div>
              </div>

              <div class="grid2" style="margin-top:10px;">
                <div>
                  <div class="label">Yaw range (°)</div>
                  <input id="yawRange" type="number" value="90">
                </div>
                <div>
                  <div class="label">Pitch range (°)</div>
                  <input id="pitchRange" type="number" value="45">
                </div>
                <div>
                  <div class="label">HFOV (°)</div>
                  <input id="hfov" type="number" value="120">
                </div>
                <div>
                  <div class="label">VFOV (°)</div>
                  <input id="vfov" type="number" value="120">
                </div>
              </div>

              <div class="small note">
                Este joystick controla el <b>viewport</b> (alineación de crop360). No afecta locomoción.
              </div>
            </div>

            <!-- Movement joystick + controller testing -->
            <div class="panel">
              <div class="panel-title">
                <span>Movement / Locomotion</span>
                <span class="pill tiny">~60 Hz while dragging</span>
              </div>

              <div class="row" style="gap:14px;">
                <canvas id="joyMoveLeft" width="200" height="200"></canvas><!-- Left -->
                <canvas id="joyMoveRight" width="200" height="200"></canvas><!-- Right -->

                <div class="grow">
                  <div class="label">Locomotion state</div>
                  <pre id="moveState" class="mini-pre">lx: 0.000
ly: 0.000
rx: 0.000
ry: 0.000
lt: 0.000
rt: 0.000</pre>

                  <div class="label" style="margin-top:10px;">Triggers</div>
                  <div class="slider-row">
                    <span class="tag">LT</span>
                    <input id="ltSlider" type="range" min="0" max="1" step="0.01" value="0">
                    <span id="ltVal" class="mono">0.00</span>
                  </div>
                  <div class="slider-row">
                    <span class="tag">RT</span>
                    <input id="rtSlider" type="range" min="0" max="1" step="0.01" value="0">
                    <span id="rtVal" class="mono">0.00</span>
                  </div>
                </div>
              </div>

              <div class="label" style="margin-top:10px;">Buttons (press / release)</div>
              <div class="btn-grid">
                <button class="btnpad" data-btn="X"><span class="k">X</span><span class="d">Left</span></button>
                <button class="btnpad" data-btn="Y"><span class="k">Y</span><span class="d">Up</span></button>
                <button class="btnpad" data-btn="A"><span class="k">A</span><span class="d">Down</span></button>
                <button class="btnpad" data-btn="B"><span class="k">B</span><span class="d">Right</span></button>

                <button class="btnpad" data-btn="LB"><span class="k">LB</span><span class="d">Shoulder</span></button>
                <button class="btnpad" data-btn="RB"><span class="k">RB</span><span class="d">Shoulder</span></button>
                <button class="btnpad" data-btn="LG"><span class="k">LG</span><span class="d">Grip</span></button>
                <button class="btnpad" data-btn="RG"><span class="k">RG</span><span class="d">Grip</span></button>

                <button class="btnpad" data-btn="LSTICK"><span class="k">L3</span><span class="d">Stick</span></button>
                <button class="btnpad" data-btn="RSTICK"><span class="k">R3</span><span class="d">Stick</span></button>
                <button class="btnpad" data-btn="MENU"><span class="k">≡</span><span class="d">Menu</span></button>
                <button class="btnpad" data-btn="META"><span class="k">◉</span><span class="d">Meta</span></button>
              </div>

              <div class="small note">
                Los botones envían eventos <code>btn</code> (1 al presionar / 0 al soltar). Los sliders afectan <code>lt/rt</code> en el mensaje <code>joy</code>.
              </div>
            </div>
          </div>
        </div>
      </aside>
    </main>
  </div>

  <script src="simulador.js"></script>
</body>
</html>